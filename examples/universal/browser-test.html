<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlueLibs Runner - Browser Example</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin: 5px;
      }
      .output {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>üöÄ BlueLibs Runner - Browser Example</h1>

    <div id="status" class="status info">Loading BlueLibs Runner...</div>

    <div>
      <h2>üß™ Test the Framework</h2>
      <button id="run-basic">Run Basic Test</button>
      <button id="run-tasks">Test Tasks</button>
      <button id="run-events">Test Events</button>
      <button id="test-errors">Test Error Handling</button>
    </div>

    <div>
      <h2>üìù Interactive Demo</h2>
      <input
        type="text"
        id="userInput"
        placeholder="Enter some data..."
        style="width: 200px"
      />
      <button id="addData">Add Data</button>
      <button id="clearData">Clear All</button>
    </div>

    <div id="output" class="output">Ready to run tests...</div>

    <script type="module">
      // Import BlueLibs Runner from the built package
      import { run, resource, task, event, hook } from "../../dist/index.js";

      const statusEl = document.getElementById("status");
      const outputEl = document.getElementById("output");

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        outputEl.textContent += `[${timestamp}] ${message}\n`;
        outputEl.scrollTop = outputEl.scrollHeight;
      }

      function setStatus(message, type = "info") {
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
      }

      // Data store resource using browser localStorage
      const dataStore = resource({
        id: "browser-data-store",
        init: async () => {
          log("üîß Initializing data store with localStorage...");

          const storageKey = "bluelibs-runner-data";

          const getData = () => {
            try {
              return JSON.parse(localStorage.getItem(storageKey) || "[]");
            } catch {
              return [];
            }
          };

          const saveData = (data) => {
            localStorage.setItem(storageKey, JSON.stringify(data));
          };

          return {
            add: (item) => {
              const data = getData();
              const entry = {
                id: Date.now(),
                value: item,
                timestamp: new Date().toISOString(),
              };
              data.push(entry);
              saveData(data);
              log(`üì¶ Added: ${item}`);
              return entry;
            },
            getAll: () => getData(),
            clear: () => {
              saveData([]);
              log("üóëÔ∏è  Cleared all data");
            },
            count: () => getData().length,
          };
        },
        dispose: async (store) => {
          log("üîß Data store disposed");
        },
      });

      // Processing task
      const processData = task({
        id: "process-data",
        dependencies: { store: dataStore },
        run: async (input, { store }) => {
          log(`‚öôÔ∏è  Processing: ${input}`);

          // Simulate some async work
          await new Promise((resolve) => setTimeout(resolve, 100));

          const result = store.add(input);
          const totalCount = store.count();

          log(`‚úÖ Processed successfully. Total items: ${totalCount}`);

          return {
            processed: result,
            totalCount,
            success: true,
          };
        },
      });

      // Data updated event
      const dataUpdated = event({
        id: "data-updated",
        payload: (data) => ({ data }),
      });

      // Hook to respond to data updates
      const onDataUpdated = hook({
        id: "on-data-updated",
        event: dataUpdated,
        dependencies: { store: dataStore },
        run: async ({ data }, { store }) => {
          log(`üîî Event: Data updated - ${data.totalCount} total items`);
          updateUI();
        },
      });

      // Main browser app
      const browserApp = resource({
        id: "browser-app",
        register: [dataStore, processData, onDataUpdated],
        dependencies: {
          store: dataStore,
          processor: processData,
        },
        init: async (config, { store, processor }) => {
          log("üöÄ Browser app initialized successfully!");

          // Set up UI event listeners
          setupEventListeners(store, processor);
          updateUI();

          return {
            store,
            processor,
            addData: async (value) => {
              const result = await processor.run(value);
              await dataUpdated.emit(result);
              return result;
            },
            clearAll: () => {
              store.clear();
              updateUI();
            },
          };
        },
        dispose: async () => {
          log("üöÄ Browser app disposed");
        },
      });

      // UI update function
      function updateUI() {
        // This would update a data display if we had one
        const dataList = document.getElementById("dataList");
        if (dataList) {
          // Update data list UI
        }
      }

      // Set up DOM event listeners
      function setupEventListeners(store, processor) {
        document
          .getElementById("addData")
          .addEventListener("click", async () => {
            const input = document.getElementById("userInput");
            const value = input.value.trim();

            if (value) {
              try {
                const result = await processor.run(value);
                await dataUpdated.emit(result);
                input.value = "";
                setStatus(`Added: ${value}`, "success");
              } catch (error) {
                log(`‚ùå Error adding data: ${error.message}`);
                setStatus(`Error: ${error.message}`, "error");
              }
            }
          });

        document.getElementById("clearData").addEventListener("click", () => {
          store.clear();
          updateUI();
          setStatus("All data cleared", "info");
        });
      }

      // Test functions
      async function runBasicTest() {
        try {
          log("=== Running Basic Test ===");

          const testResource = resource({
            id: "test-resource",
            init: async () => {
              await new Promise((resolve) => setTimeout(resolve, 50));
              return { value: 42, message: "Hello from BlueLibs Runner!" };
            },
          });

          const result = await run(testResource);
          log(
            `‚úÖ Basic test passed: ${result.message} (value: ${result.value})`,
          );
          setStatus("Basic test passed!", "success");
        } catch (error) {
          log(`‚ùå Basic test failed: ${error.message}`);
          setStatus("Basic test failed", "error");
        }
      }

      async function runTaskTest() {
        try {
          log("=== Running Task Test ===");

          const mathTask = task({
            id: "math-task",
            run: async (numbers) => {
              const sum = numbers.reduce((a, b) => a + b, 0);
              const avg = sum / numbers.length;
              return { sum, avg, count: numbers.length };
            },
          });

          const testApp = resource({
            id: "task-test-app",
            register: [mathTask],
            dependencies: { math: mathTask },
            init: async (_, { math }) => ({ math }),
          });

          const result = await run(testApp);
          const mathResult = await result.math.run([1, 2, 3, 4, 5]);

          log(
            `‚úÖ Task test passed: sum=${mathResult.sum}, avg=${mathResult.avg}`,
          );
          setStatus("Task test passed!", "success");
        } catch (error) {
          log(`‚ùå Task test failed: ${error.message}`);
          setStatus("Task test failed", "error");
        }
      }

      async function runEventTest() {
        try {
          log("=== Running Event Test ===");

          let hookCalled = false;
          let receivedData = null;

          const testEvent = event({
            id: "test-event",
            payload: (data) => ({ data }),
          });

          const testHook = hook({
            id: "test-hook",
            event: testEvent,
            run: async ({ data }) => {
              hookCalled = true;
              receivedData = data;
              log(`üîî Hook received: ${JSON.stringify(data)}`);
            },
          });

          const eventApp = resource({
            id: "event-test-app",
            register: [testHook],
            init: async () => {
              await testEvent.emit({
                message: "Hello from event!",
                timestamp: Date.now(),
              });
              return {};
            },
          });

          await run(eventApp);

          if (hookCalled && receivedData) {
            log(`‚úÖ Event test passed: Hook received data`);
            setStatus("Event test passed!", "success");
          } else {
            throw new Error("Hook was not called or data not received");
          }
        } catch (error) {
          log(`‚ùå Event test failed: ${error.message}`);
          setStatus("Event test failed", "error");
        }
      }

      async function runErrorTest() {
        try {
          log("=== Running Error Test ===");

          const failingTask = task({
            id: "failing-task",
            run: async () => {
              throw new Error("This is a test error");
            },
          });

          const errorApp = resource({
            id: "error-test-app",
            register: [failingTask],
            dependencies: { failing: failingTask },
            init: async (_, { failing }) => ({ failing }),
          });

          try {
            const result = await run(errorApp);
            await result.failing.run();
            throw new Error("Expected task to fail but it succeeded");
          } catch (error) {
            if (error.message === "This is a test error") {
              log(`‚úÖ Error test passed: Error was properly caught`);
              setStatus("Error test passed!", "success");
            } else {
              throw error;
            }
          }
        } catch (error) {
          log(`‚ùå Error test failed: ${error.message}`);
          setStatus("Error test failed", "error");
        }
      }

      // Set up test buttons
      document
        .getElementById("run-basic")
        .addEventListener("click", runBasicTest);
      document
        .getElementById("run-tasks")
        .addEventListener("click", runTaskTest);
      document
        .getElementById("run-events")
        .addEventListener("click", runEventTest);
      document
        .getElementById("test-errors")
        .addEventListener("click", runErrorTest);

      // Initialize the main app
      try {
        log("üåê Browser environment detected");
        log("üì¶ BlueLibs Runner loaded successfully");

        const result = await run(browserApp, {
          logs: { printThreshold: "info" },
          errorBoundary: true,
          shutdownHooks: true,
        });

        window.runnerApp = result; // Store globally for debugging
        setStatus("BlueLibs Runner ready! Click buttons to test.", "success");
        log("‚úÖ Framework ready for testing!");
      } catch (error) {
        log(`üí• Initialization failed: ${error.message}`);
        setStatus("Initialization failed", "error");
        console.error(error);
      }
    </script>
  </body>
</html>
