/** * Browser Compatibility Test * Tests BlueLibs Runner functionality in
browser environment */
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlueLibs Runner - Browser Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-result {
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
      }
      .pass {
        background-color: #d4edda;
        color: #155724;
      }
      .fail {
        background-color: #f8d7da;
        color: #721c24;
      }
      .info {
        background-color: #cce7ff;
        color: #004085;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>BlueLibs Runner - Browser Compatibility Test</h1>
    <div id="test-results"></div>

    <script type="module">
      // Import BlueLibs Runner
      import {
        run,
        resource,
        task,
        event,
        hook,
        createContext,
      } from "../dist/index.js";

      const testResults = document.getElementById("test-results");

      function logResult(name, success, details = "") {
        const div = document.createElement("div");
        div.className = `test-result ${success ? "pass" : "fail"}`;
        div.innerHTML = `
                <strong>${success ? "‚úÖ" : "‚ùå"} ${name}</strong>
                ${details ? `<br><small>${details}</small>` : ""}
            `;
        testResults.appendChild(div);
      }

      function logInfo(message) {
        const div = document.createElement("div");
        div.className = "test-result info";
        div.innerHTML = `<strong>‚ÑπÔ∏è ${message}</strong>`;
        testResults.appendChild(div);
      }

      async function runTests() {
        logInfo("Starting BlueLibs Runner browser compatibility tests...");

        try {
          // Test 1: Basic Resource Definition
          const testResource = resource({
            id: "test.resource",
            init: async () => ({ message: "Hello from browser!" }),
          });
          logResult(
            "Resource Definition",
            true,
            "Resource created successfully",
          );

          // Test 2: Basic Task Definition
          const testTask = task({
            id: "test.task",
            dependencies: { testResource },
            run: async (input, { testResource }) => {
              return `${testResource.message} Input: ${input}`;
            },
          });
          logResult("Task Definition", true, "Task with dependencies created");

          // Test 3: Event and Hook System
          const testEvent = event({
            id: "test.event",
          });

          let hookExecuted = false;
          const testHook = hook({
            id: "test.hook",
            on: testEvent,
            run: async (event) => {
              hookExecuted = true;
              console.log("Hook executed with data:", event.data);
            },
          });

          logResult(
            "Event/Hook Definition",
            true,
            "Event and hook system setup",
          );

          // Test 4: Context System
          const TestContext = createContext("test.context");
          let contextValue = null;

          TestContext.provide({ value: "browser-context" }, () => {
            contextValue = TestContext.use();
          });

          logResult(
            "Context System",
            contextValue?.value === "browser-context",
            `Context value: ${contextValue?.value}`,
          );

          // Test 5: Full Application Run
          const app = resource({
            id: "browser.app",
            register: [testResource, testTask, testEvent, testHook],
            dependencies: { testResource, testTask },
            init: async (_, { testResource, testTask }) => {
              return {
                resource: testResource,
                runTask: testTask,
              };
            },
          });

          logInfo("Running full BlueLibs Runner application...");

          const result = await run(app, {
            shutdownHooks: false, // No process in browser
            errorBoundary: true,
            logs: { printThreshold: "info", printStrategy: "pretty" },
          });

          logResult(
            "Application Initialization",
            true,
            "Runner started successfully",
          );

          // Test 6: Task Execution
          const taskResult = await result.runTask(testTask, "test input");
          logResult(
            "Task Execution",
            taskResult.includes("Hello from browser!") &&
              taskResult.includes("test input"),
            `Result: ${taskResult}`,
          );

          // Test 7: Event Emission
          await result.emitEvent(testEvent, { test: "data" });

          // Give hook time to execute
          await new Promise((resolve) => setTimeout(resolve, 10));

          logResult(
            "Event Emission",
            hookExecuted,
            "Event emitted and hook executed",
          );

          // Test 8: Resource Access
          const resourceValue = result.getResourceValue(testResource);
          logResult(
            "Resource Access",
            resourceValue.message === "Hello from browser!",
            `Resource value: ${JSON.stringify(resourceValue)}`,
          );

          // Test 9: Platform Detection
          logInfo("Platform Detection Test");
          const userAgent = navigator.userAgent;
          const isBrowser = typeof window !== "undefined";
          logResult(
            "Browser Environment",
            isBrowser,
            `User Agent: ${userAgent}`,
          );

          // Test 10: Web APIs Availability
          const webApis = {
            setTimeout: typeof setTimeout !== "undefined",
            addEventListener: typeof addEventListener !== "undefined",
            crypto: typeof crypto !== "undefined",
            AbortController: typeof AbortController !== "undefined",
            URL: typeof URL !== "undefined",
          };

          Object.entries(webApis).forEach(([api, available]) => {
            logResult(`Web API: ${api}`, available);
          });

          // Test 11: Async Context (Platform Abstraction)
          logInfo("Testing async context abstraction...");

          // This should work with the universal adapter
          const contextTest = await TestContext.provide(
            { test: "async" },
            async () => {
              return new Promise((resolve) => {
                setTimeout(() => {
                  const ctx = TestContext.use();
                  resolve(ctx);
                }, 10);
              });
            },
          );

          logResult(
            "Async Context Abstraction",
            contextTest?.test === "async",
            "AsyncLocalStorage polyfill working",
          );

          // Clean up
          await result.dispose();
          logResult(
            "Application Disposal",
            true,
            "Runner disposed successfully",
          );

          logInfo(
            "üéâ All tests completed! BlueLibs Runner is fully compatible with browser environment.",
          );
        } catch (error) {
          logResult("Critical Error", false, error.message);
          console.error("Test error:", error);
        }
      }

      // Run tests when page loads
      runTests();
    </script>
  </body>
</html>
